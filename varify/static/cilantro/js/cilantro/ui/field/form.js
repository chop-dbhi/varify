define(["underscore","backbone","marionette","loglevel","../../core","../base","../charts","../config","./info","./stats","./controls"],function(t,i,e,o,n,s,r,a,h,l,d){var c=s.LoadView.extend({message:"Loading fields..."}),p=e.Layout.extend({className:"field-form",getTemplate:function(){return this.options.condensed?"field/form-condensed":"field/form"},options:{info:!0,chart:!1,stats:!0,controls:!0,condensed:!1},ui:{apply:"[data-action=apply]",update:"[data-action=update]",state:"[data-target=state]"},events:{"click @ui.apply":"applyFilter","click @ui.update":"applyFilter"},filterEvents:{applied:"validateFilter",unapplied:"validateFilter",change:"validateFilter"},regions:{info:".info-region",stats:".stats-region",chart:".chart-region",controls:".controls-region"},regionViews:{info:h.FieldInfo,stats:l.FieldStats,chart:r.FieldChart,controls:d.FieldControls},initialize:function(t){if(this.data={},!(this.data.concept=t.concept))throw new Error("concept required");if(!(this.data.context=t.context))throw new Error("context required");t.filter||(t.filter=this.data.context.define({concept:this.data.concept.id,field:this.model.id})),this.data.filter=t.filter},onRender:function(){this.$el.attr("id",this.data.filter.id),this.options.condensed&&this.$el.addClass("condensed"),this.options.info&&this.renderInfo(),this.options.stats&&this.model.stats&&this.renderStats(),this.options.controls&&this.renderControls(),this.options.chart&&this.model.links.distribution&&this.renderChart(),this.validateFilter(),e.bindEntityEvents(this,this.data.filter,e.getOption(this,"filterEvents"))},renderInfo:function(){var i={model:this.model};t.isObject(this.options.info)&&t.extend(i,this.options.info),this.info.show(new this.regionViews.info(i))},renderStats:function(){var i={model:this.model,collection:this.model.stats};t.isObject(this.options.stats)&&t.extend(i,this.options.stats),this.stats.show(new this.regionViews.stats(i))},renderControls:function(){var e=[];if(t.each(this.options.controls,function(i){var o={model:this.model,filter:this.data.filter};t.isObject(i)?t.extend(o,i):o.control=i,e.push(o)},this),e.length>0){var o=new this.regionViews.controls({collection:new i.Collection(e)});this.controls.show(o)}},renderChart:function(){var i;i=this.options.condensed?{chart:{height:100}}:{chart:{height:200}},i.context=this.context,i.model=this.model,t.isObject(this.options.chart)&&t.extend(i,this.options.chart),this.chart.show(new this.regionViews.chart(i))},renderFilter:function(){this.ui.state.hide(),this.ui.apply.prop("disabled",!0),this.ui.update.prop("disabled",!0);var i=this.data.context.isFilterApplied(this.data.filter),e=!this.isEmpty&&!this.validationErrors;if(i){this.ui.apply.hide(),this.ui.update.show();var o=[];this.controls.currentView.children.each(function(i){i.view&&(o=o.concat(t.keys(i.view.get())))}),this.data.context.hasFilterChanged(this.data.filter,o)&&(e?this.ui.update.prop("disabled",!1):this.validationErrors&&this.ui.state.html(this.validationErrors.join("<br>")).show())}else this.ui.apply.show(),this.ui.update.hide(),e?this.ui.apply.prop("disabled",!1):!this.isEmpty&&this.validationErrors&&this.ui.state.html(this.validationErrors.join("<br>")).show()},validateFilter:function(){var t,i,e=[],o=this.data.filter.toJSON();return this.controls.currentView.children.each(function(n){n.view&&(i=n.view.validate(o),i&&e.push(i),t=n.view.isEmpty(o))}),this.isEmpty=t,this.validationErrors=e.length?e:null,this.renderFilter(),!this.validationErrors&&!this.isEmpty},applyFilter:function(t){t.preventDefault(),this.validateFilter()&&this.data.filter.apply()}}),f=s.ErrorView.extend({}),u=e.View.extend({itemView:p,emptyView:c,errorView:f,collectionEvents:{reset:"render"},initialize:function(){if(this.data={},!(this.data.concept=this.options.concept))throw new Error("concept required");if(!(this.data.context=this.options.context))throw new Error("context required");this._children=[]},render:function(){if(this.collection.length){var t=this;this.collection.each(function(i,e){t.renderItem(i,e)})}return this},close:function(){if(!this.isClosed){for(var t;t=this._children.pop();)t.close();e.View.prototype.close.call(this)}},renderItem:function(i,e){var n=t.extend({},this.options,{model:i,context:this.data.context,concept:this.data.concept,index:e});this.collection.length<2?n.info=!1:e>0&&this.options.condense&&(n.condensed=!0);var s=a.resolveFormOptions(i,"fields");if(t.extend(n,s.options),s.module){var r=this;require([s.module],function(t){r.createView(t,n)},function(t){r.showErrorView(i),o.debug(t)})}else this.createView(s.view||this.itemView,n)},createView:function(t,i){try{var e=new t(i);e.render(),this._children.push(e),n.dom.insertAt(this.$el,i.index,e.el)}catch(o){if(this.showErrorView(i.model),n.config.get("debug"))throw o}},showErrorView:function(t){var i=new this.errorView({model:t});i.render(),this._children.push(i),this.$el.html(i.el)}}),w=e.ItemView.extend({tagName:"li",template:"field/link",ui:{anchor:"a"},serializeData:function(){return{name:this.model.get("alt_name")||this.model.get("name")}}}),m=e.CompositeView.extend({template:"field/links",itemView:w,itemViewContainer:"[data-target=links]",onAfterItemAdded:function(t){var i=this.options.concept,e="c"+i.id+"f"+t.model.id;t.ui.anchor.attr("href","#"+e)}});return{FieldForm:p,FieldFormCollection:u,FieldLinkCollection:m}});
//# sourceMappingURL=form.js.map