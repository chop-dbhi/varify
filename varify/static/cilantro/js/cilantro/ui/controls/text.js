define(["underscore","backbone","marionette","../../core","../search","../base","./base"],function(e,t,n,r,o,i,h){var s={a:!0,about:!0,above:!0,across:!0,after:!0,afterwards:!0,again:!0,against:!0,all:!0,almost:!0,alone:!0,along:!0,already:!0,also:!0,although:!0,always:!0,am:!0,among:!0,amongst:!0,amoungst:!0,amount:!0,an:!0,and:!0,another:!0,any:!0,anyhow:!0,anyone:!0,anything:!0,anyway:!0,anywhere:!0,are:!0,around:!0,as:!0,at:!0,back:!0,be:!0,became:!0,because:!0,become:!0,becomes:!0,becoming:!0,been:!0,before:!0,beforehand:!0,behind:!0,being:!0,below:!0,beside:!0,besides:!0,between:!0,beyond:!0,bill:!0,both:!0,bottom:!0,but:!0,by:!0,call:!0,can:!0,cannot:!0,cant:!0,co:!0,con:!0,could:!0,couldnt:!0,cry:!0,de:!0,describe:!0,detail:!0,"do":!0,does:!0,done:!0,down:!0,due:!0,during:!0,each:!0,eg:!0,eight:!0,either:!0,eleven:!0,"else":!0,elsewhere:!0,empty:!0,enough:!0,etc:!0,even:!0,ever:!0,every:!0,everyone:!0,everything:!0,everywhere:!0,except:!0,few:!0,fifteen:!0,fify:!0,fill:!0,find:!0,fire:!0,first:!0,five:!0,"for":!0,former:!0,formerly:!0,forty:!0,found:!0,four:!0,from:!0,front:!0,full:!0,further:!0,get:!0,give:!0,go:!0,had:!0,has:!0,hasnt:!0,have:!0,he:!0,hence:!0,her:!0,here:!0,hereafter:!0,hereby:!0,herein:!0,hereupon:!0,hers:!0,herself:!0,him:!0,himself:!0,his:!0,how:!0,however:!0,hundred:!0,ie:!0,"if":!0,"in":!0,inc:!0,indeed:!0,interest:!0,into:!0,is:!0,it:!0,its:!0,itself:!0,keep:!0,last:!0,latter:!0,latterly:!0,least:!0,less:!0,ltd:!0,made:!0,many:!0,may:!0,me:!0,meanwhile:!0,might:!0,mill:!0,mine:!0,more:!0,moreover:!0,most:!0,mostly:!0,move:!0,much:!0,must:!0,my:!0,myself:!0,name:!0,namely:!0,neither:!0,never:!0,nevertheless:!0,next:!0,nine:!0,no:!0,nobody:!0,none:!0,noone:!0,nor:!0,not:!0,nothing:!0,now:!0,nowhere:!0,of:!0,off:!0,often:!0,on:!0,once:!0,one:!0,only:!0,onto:!0,or:!0,other:!0,others:!0,otherwise:!0,our:!0,ours:!0,ourselves:!0,out:!0,over:!0,own:!0,part:!0,per:!0,perhaps:!0,please:!0,put:!0,rather:!0,re:!0,same:!0,see:!0,seem:!0,seemed:!0,seeming:!0,seems:!0,serious:!0,several:!0,she:!0,should:!0,show:!0,side:!0,since:!0,sincere:!0,six:!0,sixty:!0,so:!0,some:!0,somehow:!0,someone:!0,something:!0,sometime:!0,sometimes:!0,somewhere:!0,still:!0,such:!0,system:!0,take:!0,ten:!0,than:!0,that:!0,the:!0,their:!0,them:!0,themselves:!0,then:!0,thence:!0,there:!0,thereafter:!0,thereby:!0,therefore:!0,therein:!0,thereupon:!0,these:!0,they:!0,thickv:!0,thin:!0,third:!0,"this":!0,those:!0,though:!0,three:!0,through:!0,throughout:!0,thru:!0,thus:!0,to:!0,together:!0,too:!0,top:!0,toward:!0,towards:!0,twelve:!0,twenty:!0,two:!0,un:!0,under:!0,until:!0,up:!0,upon:!0,us:!0,very:!0,via:!0,was:!0,way:!0,we:!0,well:!0,were:!0,what:!0,whatever:!0,when:!0,whence:!0,whenever:!0,where:!0,whereafter:!0,whereas:!0,whereby:!0,wherein:!0,whereupon:!0,wherever:!0,whether:!0,which:!0,"while":!0,whither:!0,who:!0,whoever:!0,whole:!0,whom:!0,whose:!0,why:!0,will:!0,"with":!0,within:!0,without:!0,would:!0,yet:!0,you:!0,your:!0,yours:!0,yourself:!0,yourselves:!0,didnt:!0,doesnt:!0,dont:!0,isnt:!0,wasnt:!0,youre:!0,hes:!0,ive:!0,theyll:!0,whos:!0,wheres:!0,whens:!0,whys:!0,hows:!0,whats:!0,shes:!0,im:!0,thats:!0},a=function(e){for(var t,n=[],r=0;r<e.length;r++)t=e[r],(/^[+-]?["']/.test(t)||(t=t.toLowerCase().replace(/[^a-zA-Z]/,""),!s[t]))&&n.push(e[r]);return n},l=/[+-]?(?:[^\s"']+|"([^"]*)"|'([^']*)')/g,c=function(e){var t=e.match(l)||[];return t.length&&(t=a(t)),t},u=function(e){return e.replace(/^[\-\+]?["']?/,"").replace(/["']?$/,"")},w=1,d=3,v=13,p=function(e,t,n){if(e.nodeType===d){var r=e.data.search(t);if(r>=0&&e.data.length>0){var o=e.data.match(t),i=document.createElement("span"),h=e.splitText(r);return h.splitText(o[0].length),i.appendChild(h.cloneNode(!0)),i.className=n,h.parentNode.replaceChild(i,h),!0}}else if(e.nodeType===w&&e.childNodes&&!/(script|style)/i.test(e.tagName))for(var s=0;s<e.childNodes.length;)p(e.childNodes[s],t,n)&&s++,s++},f=function(t,n,r){e.isRegExp(n)||(n=new RegExp(n,"ig")),t.each(function(){return p(this,n,r)})},m=n.ItemView.extend({tagName:"p",template:"controls/text/preview-item"}),g=n.CompositeView.extend({template:"controls/text/preview-list",itemView:m,itemViewContainer:".items",onRender:function(){var t=e.map(c(this.options.query),function(e){return u(e)}),n=this.$(this.itemViewContainer).children();f(n,t.join("|"),"highlight")}}),y=t.Collection.extend({parse:function(e){return e.objects||e.values}}),b=h.ControlLayout.extend({template:"controls/text/layout",options:{preview:!1},regions:{search:"[data-target=search-region]",preview:"[data-target=preview-region]"},regionViews:{search:o.Search,preview:g},collectionEvents:{request:"showPreviewLoading",error:"showPreviewError",sync:"showPreview"},events:{"keyup [data-target=search-region] input":"triggerPreview"},constructor:function(e){e.collection=new y,e.collection.url=function(){return e.model.links.values},h.ControlLayout.prototype.constructor.call(this,e)},onRender:function(){var e=new this.regionViews.search;this.listenTo(e,"search",this.change),this.search.show(e)},triggerPreview:function(e){if(this.options.preview&&e&&e.which===v){e.preventDefault(),e.stopPropagation(),this.showPreviewLoading();var t=this.get(),n=this.previewQuery=t.query;this.context?this.context.set({json:t}):this.context=r.data.contexts.add({json:t});var o=this;this.context.save().fail(function(){o.showPreviewError()}).done(function(){o.previewQuery===n&&o.collection.fetch({reset:!0,data:{aware:1,limit:5,context:o.context.id}})})}},showPreviewLoading:function(){this.preview.show(new i.LoadView({message:"Loading preview..."}))},showPreviewError:function(){this.preview.show(new i.ErrorView({message:"There was an error loading the preview."}))},showPreview:function(){var e=new this.regionViews.preview({query:this.previewQuery,collection:this.collection});this.preview.show(e)},validate:function(e){return e.children||e.value?void 0:"At least one keyword must be entered"},get:function(){var t=this.search.currentView.ui.input.val(),n=c(t);if(n.length){var r=this.model.id,o={field:r,type:"and",children:[]},i=[],h=[],s=[];return e.each(n,function(e){var t=e.charAt(0);"+"===t?i.push(u(e)):"-"===t?h.push(u(e)):s.push(u(e))}),1===i.length?o.children.push({field:r,operator:"icontains",value:i[0]}):i.length>1&&o.children.push({field:r,type:"and",children:e.map(i,function(e){return{field:r,operator:"icontains",value:e}})}),1===h.length?o.children.push({field:r,operator:"-icontains",value:h[0]}):h.length>1&&o.children.push({field:r,type:"and",children:e.map(h,function(e){return{field:r,operator:"-icontains",value:e}})}),1===s.length?o.children.push({field:r,operator:"icontains",value:s[0]}):s.length>1&&o.children.push({field:r,operator:"iregex",value:"("+s.join("|")+")"}),1===o.children.length&&(o=o.children[0]),o.query=t,o}},set:function(e){this._changing||e.query&&this.search.currentView.ui.input.val(e.query)}});return{TextControl:b}});
//# sourceMappingURL=text.js.map