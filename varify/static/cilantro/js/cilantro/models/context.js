define(["underscore","backbone","loglevel","../core","./base","./filters"],function(e,t,i,s,n,r){var l=function(){var t=[];e.each(s.config.get("filters.required"),function(e){t.push(e)});var n=s.config.get("query.concepts.required");return n&&(i.warn('The "query.concepts.required" option is deprecated, use "filters.required" instead with fully qualified lookups.'),e.each(n,function(e){t.push({concept:e})})),t},o=n.Model.extend({options:{saveDelay:300},initialize:function(t,i){t=t||{},this.requiredFilters=l(),this._filters=new r.Filters(t.json,e.defaults({parse:!0},i)),this.filters=new r.Filters(t.json,e.defaults({parse:!0},i)),this.listenTo(this._filters,{apply:this.apply,unapply:this.unapply}),this.listenTo(this.filters,{unapply:this.unapply,"change:enabled":function(){this._save()}}),this.on("change:json",function(t,i,s){this.filters.set(i,e.defaults({parse:!0},s)),s.reset&&this._filters.set(i,e.defaults({parse:!0,remove:!1},s)),this.filters.each(function(e){this.isFilterRequired(e.attributes)?e.set("required",!0):e.unset("required")},this)}),this.on("sync",function(e,t,i){i=i||{},this.validate(),i.silent!==!0&&s.trigger(s.CONTEXT_SYNCED,this,"success")}),this._save=e.debounce(this.save,this.options.saveDelay)},validate:function(){var t=[];return e.each(this.requiredFilters,function(i){var s,n=this.filters.findWhere(i);n?n.isEnabled()||(s="disabled"):s="undefined",s&&t.push(e.extend({reason:s},i))},this),t.length?(s.trigger(s.CONTEXT_INVALID,t),"One or more filters are invalid"):void 0},isFilterRequired:function(t){return e.any(this.requiredFilters,function(i){return e.isEqual(e.pick(t,e.keys(i)),i)})},_apply:function(e,t){var i=e.toJSON({id:!0});i.required=this.isFilterRequired(i);var s=this.filters.get(i.id);s?(s.clear({silent:!0}),s.set(i)):s=this.filters.add(i,t),s.set("enabled",!0,{silent:!0});var n=this._filters.get(s);n.trigger("applied",n,t),s.stopListening(this),s.listenToOnce(this,"request",function(e,t,i){this.trigger("request",this,t,i)}),s.listenToOnce(this,"sync",function(e,t,i){this.trigger("sync",this,this.toJSON(),i)})},apply:function(i,s){i instanceof t.Collection?i=i.slice():e.isArray(i)||(i=[i]),e.each(i,function(e){this._apply(e,s)},this),s&&s.save===!1||this._save()},_unapply:function(e,t){var s=e.toJSON({id:!0});if(this.isFilterRequired(s))return void i.debug("skipping unapplying required filter",s);var n=this.filters.remove(s,t);if(n){var r=this._filters.get(n);r.trigger("unapplied",r,t),n.stopListening(this)}},unapply:function(i,s){i instanceof t.Collection?i=i.slice():e.isArray(i)||(i=[i]),e.each(i,function(e){this._unapply(e,s)},this),s&&s.save===!1||this._save()},define:function(e){var t=this._filters.model.prototype.generateId(e),i=this._filters.get(t);return i||(i=this._filters.create(e)),i},toJSON:function(){var e=n.Model.prototype.toJSON.call(this),t=this.filters.toJSON();return e.json=t.length?{type:"and",children:t}:null,e},isSession:function(){return this.get("session")},isArchived:function(){return this.get("archived")},isFilterApplied:function(e){return void 0!==this.filters.get(e)},hasFilterChanged:function(t,i){var s=this.filters.get(t);if(s)return i||(i=e.keys(t.attributes)),e.any(i,function(i){return!e.isEqual(t.get(i),s.get(i))})}}),a=n.SessionCollection.extend({model:o});return{Context:o,ContextCollection:a}});
//# sourceMappingURL=context.js.map